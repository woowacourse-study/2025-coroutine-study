# Chapter 5. async와 Deferred

## async

> launch 코루틴 빌더는 코루틴에서 결괏값이 반환되지 않기 때문에 Job 객체를 반환하는데,  
>  async 코루틴 빌더는 코루틴에서 결괏값을 담아 반환하기 위해 Deferred<T> 타입의 객체를 반환한다.

<br>

## Deferred

- 미래의 어느 시점에 결괏값이 반환될 수 있음을 표현하는 코루틴 객체

### await 함수

- await의 대상이 된 Deferred 코루틴이 실행 완료될 때까지 await 함수를 호출한 코루틴을 일시 중단함
- Deferred 코루틴이 실행 완료되면 결괏값을 반환하고 호출부의 코루틴을 재개함
- await 함수의 호출 시점에 따라 코루틴이 순차적으로 처리될 수도 있고 동시에 처리될 수도 있음
- 각 코루틴이 동시에 실행될 수 있도록 만드는 것은 코루틴의 성능 측면에서 매우 중요함

### awaitAll 함수

- 복수의 Deferred 객체로부터 결괏값을 수신하기 위한 코루틴 라이브러리 함수
- 가변 인자로 Deferred 타입의 객체를 받아 인자로 받은 모든 Deferred 코루틴으로부터 결과가 수신될 때까지 호출부의 코루틴을 일시 중단함
- 결과가 모두 수신되면 Deferred 코루틴들로부터 수신한 결괏값들을 List로 만들어 반환하고 호출부의 코루틴을 재개함

<br>

## withContext

> withContext 함수가 호출되면 함수의 인자로 설정된 CoroutineContext 객체를 사용해 block 람다식을 실행하고, 완료되면 그 결과를 반환한다.

### withContext의 동작 방식

- async-await 쌍은 새로운 코루틴을 생성해 작업을 처리하지만 withContext 함수는 실행 중이던 코루틴을 그대로 유지한 채로 코루틴의 실행 환경만 변경해 작업을 처리함
- withContext 함수는 새로운 코루틴을 만들지 않기 때문에 하나의 코루틴에서 withContext 함수가 여러 번 호출되면 순차적으로 실행됨
- 복수의 독립적인 작업이 병렬로 실행돼야 하는 상황에 withContext를 사용할 경우 성능에 문제를 일으킬 수 있음

### Context Switching

- withContext 함수가 호출되면 실행 중인 코루틴의 실행 환경이 withContext 함수의 context 인자 값으로 변경돼 실행됨
- withContext 함수는 함수의 block 람다식이 실행되는 동안 코루틴의 실행 환경을 변경시킴
