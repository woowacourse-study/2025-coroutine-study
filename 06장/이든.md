# Chapter 6. CoroutineContext

## 6.1 CoroutineContext의 구성요소

- CoroutineName: 코루틴의 이름을 설정
- CoroutineDispatcher: 코루틴을 스레드에 할당해 실행
- Job: 코루틴의 추상체로 코루틴을 조작하는 데 사용
- CoroutineExceptionHandler: 코루틴에서 발생한 예외를 처리

## 6.2 CoroutineContext 구성하기

### 6.2.1 CoroutineContext가 구성요소를 관리하는 방법

| 키 | 값 |
| --- | --- |
| CoroutineName 키 | CoroutineName 객체 |
| CoroutineDispatcher 키 | CoroutineDispatcher 객체 |
| Job 키 | Job 객체 |
| CoroutineExceptionHandler 키 | CoroutineExceptionHandler 객체 |
- 각 구성 요소는 고유한 키를 가지며, 키에 대한 중복된 값은 허용하지 않음

### 6.2.2 CoroutineContext 구성

- CoroutineContext 객체는 키-값 쌍으로 구성요소를 관리하지만 키에 값을 직접 대입하는 방법을 사용하지 않음
- 대신 CoroutineContext 객체 간에 더하기 연산자(+)를 사용해 CoroutineContext 객체를 구성

```kotlin
val coroutineContext: CoroutineContext = newSingleThreadContext("MyThread") 
+ CoroutineName("MyCoroutine")
	
	launch(context = coroutineContext) {
		println("[$(Thread.currentThread().name)] 실행")
	}
}

결과
[MyThread @MyCoroutine#2] 실행
```

- 구성 요소가 없는 CoroutineContext는 EmptyCoroutineContext를 통해 만들 수 있음

### 6.2.3 CoroutineContext 구성 요소 덮어씌우기

- 만약 CoroutineContext 객체에 같은 구성 요소가 둘 이상 더해진다면 나중에 추가된 CoroutineContext 구성 요소가 이전 값을 덮어 씌움
- CoroutineContext 객체는 키-값 쌍으로 구성 요소를 관리하기 때문에 같은 구성 요소에 대해서는 마지막에 들어온 하나의 값만 취함

### 6.2.4 여러 구성 요소로 이뤄진 CoroutineContext 합치기

- 여러 구성 요소로 이뤄진 CoroutineContext 객체 2개가 합쳐지고 2개의 CoroutineContext 객체에 동일한 키를 가진 구성 요소가 있다면 나중에 들어온 값이 선택됨

```kotlin
val context1 = CoroutineName("Name1") + newSingleThreadContext("Thread1")
val context2 = CoroutineName("Name2") + newSingleThreadContext("Thread2")
val combined = context1 + context2

결과: Name2와 Thread2가 선택됨
```

### 6.2.5 CoroutineContext에 Job 생성해 추가하기

- Job() 함수를 호출하여 직접 Job을 생성할 수 있음
- Job 객체를 직접 생성해 추가하면 코루틴의 구조화가 깨질 수 있으므로 주의해야 함

## 6.3 CoroutineContext 구성 요소에 접근하기

### 6.3.1 CoroutineContext 구성 요소의 키

- CoroutineContext 구성 요소의 키는 CoroutineContext.Key 인터페이스를 구현해 만들 수 있는데 일반적으로 CoroutineContext 구성 요소는 자신의 내부에 키를 싱글톤 객체로 구현함
- Job 인터페이스 내부에도 Key가 동반 객체로 선언된 것을 볼 수 있음

| CoroutineContext 구성 요소 | CoroutineContext 구성 요소 키 |
| --- | --- |
| CoroutineName | CoroutineName.Key |
| Job | Job.key |
| CoroutineDispatcher | CoroutineDispatcher.Key |
| CoroutineExceptionHandler | CoroutineExceptionHandler.Key |

### 6.3.2 키를 사용해 CoroutineContext 구성 요소에 접근하기

1. 싱글톤 키 사용
`val nameFromContext = coroutineContext[CoroutineName.Key]`

2. 구성 요소 자체를 키로 사용 (권장)
`val nameFromContext = coroutineContext[CoroutineName]`

3. 인스턴스의 key 프로퍼티 사용
`val nameFromContext = coroutineContext[coroutineName.key]`

## 6.4 CoroutineContext 구성 요소 제거하기

- CoroutineContext 객체는 구성 요소를 제거하기 위한 minusKey 함수를 제공
- minusKey 함수는 구성 요소의 키를 인자로 받아 해당 구성 요소를 제거한 CoroutineContext 객체를 반환

- `minusKey` 를 호출한 CoroutineContext 객체는 그대로 유지되고, 구성 요소가 제거된 **새로운 CoroutineContext 객체를 반환**
- 불변(immutable) 객체이므로 안전
