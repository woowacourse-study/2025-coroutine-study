# CoroutineContext

## CoroutineContext의 구성요소

1. CoroutineName : 코루틴의 이름을 설정  
`CoroutineName("MyCoroutine")`  
2. CoroutineDispatcher: 코루틴을 스레드에 할당해 실행한다.  
`newSingleThreadContext("MyThread")`,`Dispatcher.IO`  
4. Job: 코루틴의 추상체로 코루틴을 조작하는 데 사용된다.  
`Job()`  
6. CoroutineExceptionHandler: 코루틴에서 발생한 예외를 처리한다.  
>  CoroutineExceptionHandler는 8장에서 추가로 다룬다.  

## CoroutineContext 구성하기

CoroutineContext객체는 키-값 쌍으로 각 구성요소를 관리한다.
|키|값|
|------|---|
|CoroutineName 키|CoroutineName 객체|
|CoroutineDispatcher 키|CoroutineDispatcher 객체|
|Job 키|Job 객체|
|CoroutineExceptionHandler 키|CoroutineExceptionHandler 객체|

> 각 구성요소는 고유한 키를 가지며, 키에 대한 중복된 값은 허용하지 않는다.
> 따라서, 각 구성요소들은 중복된 객체를 통해 가질 수 없다. 예를들어, 하나의 Context는 두개의 Dispathcer를 가질 수없다.

### CoroutineContext 구성

> CoroutineContext는 키에 값을 직접 대입하는 방법을 사용하지 않고 객체간 더하기 연산자를 사용해 CoroutineContext 객체를 구성한다.

```kotlin
public operator fun plus(context: CoroutineContext): CoroutineContext =
        if (context === EmptyCoroutineContext) this else // fast path -- avoid lambda creation
            context.fold(this) { acc, element ->
                val removed = acc.minusKey(element.key)
                if (removed === EmptyCoroutineContext) element else {
                    // make sure interceptor is always last in the context (and thus is fast to get when present)
                    val interceptor = removed[ContinuationInterceptor]
                    if (interceptor == null) CombinedContext(removed, element) else {
                        val left = removed.minusKey(ContinuationInterceptor)
                        if (left === EmptyCoroutineContext) CombinedContext(element, interceptor) else
                            CombinedContext(CombinedContext(left, element), interceptor)
                    }
                }
            }
```
위의 더하기 연산자에 대한 내용을 살펴 보면

> 설정되지 않는 구성요소는 설정되지 않은 상태로 유지를 하고
> 새로 설정을 하게 되면 이미 설정되어 있는 구성요소는 삭제하고 새로 덮어씌우는 것을 볼 수 있다.

## CoroutineContext 구성 요소에 접근하기

|CoroutineContext 구성 요소|CoroutineContext 구성 요소 키|
|------|---|
|CoroutineName|CoroutineName.Key|
|CoroutineDispatcher|CoroutineDispatcher.Key|
|Job|Job.Key|
|CoroutineExceptionHandler|CoroutineExceptionHandler.Key|

위처럼 해당 Key를 통하여 값에 접근할 수 있습니다.

```kotlin
fun main() = runBlocking<Unit> {
    val coroutineContext = CoroutineName("MyCoroutine") + Dispatchers.Default
    val nameFromCoroutineContext = coroutineContext[CoroutineName.Key] // coroutineContext[CoroutineName] 와 동일

    println(nameFromCoroutineContext) // 반환값: CoroutineName(MyCoroutine)
}
```
위 코드를 보면 구성요소를 키를 통해 해당 값만 불러올 수 있습니다.

## CoroutineContext 구성 요소에 제거하기

```kotlin
fun main() = runBlocking<Unit> {
    val coroutineContext = CoroutineName("MyCoroutine") + Dispatchers.Default + Job()
    println("${coroutineContext[CoroutineName]}") // 반환값: CoroutineName(MyCoroutine)

    val deletedCoroutineContext = coroutineContext.minusKey(CoroutineName.Key)

    println("${deletedCoroutineContext[CoroutineName]}") // 반환값: null
}
```
위 코드를 보면 구성요소 키를 통해 해당 값만 삭제 할 수 있습니다.

### minusKey의 주의할 점

위 코드에서 본 것처럼 minusKey는 해당 객체의 값을 제거하는 것이 아닌 제거한 후의 객체를 반환한다는 것이다.




