# Chapter 7. 구조화된 동시성

## 구조화된 동시성

> 코루틴은 구조화된 동시성의 원칙을 사용해 비동기 작업인 코루틴을 부모-자식 관계로 구조화함으로써  
> 코루틴이 보다 안전하게 관리되고 제어될 수 있도록 한다.

- 부모 코루틴의 실행 환경이 자식 코루틴에게 상속된다.
- 작업을 제어하는 데 사용된다.
- 부모 코루틴이 취소되면 자식 코루틴도 취소된다.
- 부모 코루틴은 자식 코루틴이 완료될 때까지 대기한다.
- CoroutineScope를 사용해 코루틴이 실행되는 범위를 제한할 수 있다.

<br>

## 실행 환경 상속

### 부모 코루틴의 실행 환경 상속

- 부모 코루틴은 자식 코루틴에게 실행 환경을 상속함
- 부모 코루틴이 자식 코루틴을 생성하면 부모 코루틴의 CoroutineContext가 자식 코루틴에게 전달됨

### 실행 환경 덮어씌우기

- 자식 코루틴을 생성하는 코루틴 빌더 함수로 새로운 CoroutineContext 객체가 전달되면 부모 코루틴에게서 전달받은 CoroutineContext 구성 요소들은 자식 코루틴 빌더 함수로 전달된 CoroutineContext 객체의 구성 요소들로 덮어씌워짐
- 자식 코루틴 빌더에 새로운 CoroutineContext 객체를 전달함으로써 부모 코루틴으로부터 전달된 CoroutineContext 객체의 구성 요소를 재정의할 수 있음
- 다른 CoroutineContext 구성 요소들과 다르게 Job 객체는 상속되지 않고 코루틴 빌더 함수가 호출되면 새롭게 생성됨

### 구조화에 사용되는 Job

- 코루틴 빌더가 호출되면 Job 객체는 새롭게 생성되지만 생성된 Job 객체는 내부에 정의된 parent 프로퍼티를 통해 부모 코루틴의 Job 객체에 대한 참조를 가짐
- 부모 코루틴의 Job 객체는 Sequence 타입의 children 프로퍼티를 통해 자식 코루틴의 Job에 대한 참조를 가져 자식 코루틴의 Job 객체와 부모 코루틴의 Job 객체는 양방향 참조를 가짐

![IMG_0573](https://github.com/user-attachments/assets/5190a383-e9ec-4b2c-ab78-8dea47218eab)

<br>

## 코루틴의 구조화

> 코루틴의 구조화는 하나의 큰 비동기 작업을 작은 비동기 작업으로 나눌 때 일어난다.  
> 코루틴을 구조화하는 가장 중요한 이유는 코루틴을 안전하게 관리하고 제어하기 위함이다.

- 코루틴으로 취소가 요청되면 자식 코루틴으로 전파됨
- 부모 코루틴은 모든 자식 코루틴이 실행 완료되어야 완료될 수 있음

### 취소의 전파

- 특정 코루틴이 취소되면 하위의 모든 코루틴이 취소됨
- 특정 코루틴에 취소가 요청되면 취소는 자식 코루틴 방향으로만 전파되며, 부모 코루틴으로는 취소가 전파되지 않음

### 부모 코루틴의 자식 코루틴에 대한 완료 의존성

- 부모 코루틴이 자식 코루틴에 대해 완료 의존성을 가짐
- 부모 코루틴이 마지막 코드를 실행하고 나서 더이상 실행할 코드가 없음에도 즉시 실행 완료되지 않는 이유는 부모 코루틴은 자식 코루틴이 완료되는 시점까지 완료될 수 없는 특정을 갖고 있기 때문

### 실행 완료 중 상태

- 부모 코루틴의 모든 코드가 실행됐지만 자식 코루틴이 실행 중인 경우 부모 코루틴이 갖는 상태
- ‘실행 완료 중’ 상태의 부모 코루틴은 자식 코루틴들이 모두 실행 완료되면 자동으로 ‘실행 완료’ 상태로 바뀜

![IMG_0574](https://github.com/user-attachments/assets/f5abf7c7-baca-483f-8f54-b87a0b3b53ff)

<br>

## CoroutineScope

> CoroutineScope 객체는 자신의 범위 내에서 생성된 코루틴들에게 실행 환경을 제공하고, 이들의 실행 범위를 관리하는 역할을 한다.
> CoroutineScope 내부에서 실행되는 코루틴이 CoroutineScope로부터 코루틴 실행 환경인 CoroutineContext를 제공받는다.

### 코루틴에게 실행 환경을 제공하는 CoroutineScope

- 코루틴이 부모 코루틴의 CoroutineContext 객체를 가진 CoroutineScope 객체로부터 실행 환경을 상속받음
1. 수신 객체인 CoroutineScope로부터 CoroutineContext 객체를 제공받는다.
2. 제공받은 CoroutineContext 객체에 launch 함수의 context 인자로 넘어온 CoroutineContext를 더한다.
3. 생성된 CoroutineContext에 코루틴 빌더 함수가 호출되어 새로 생성되는 Job을 더한다. 이때 CoroutineContext를 통해 전달되는 Job 객체는 새로 생성되는 Job 객체의 부모 Job 객체가 된다.

### CoroutineScope에 속한 코루틴의 범위

- CoroutineScope 객체를 사용해 실행되는 모든 코루틴이 CoroutineScope의 범위에 포함됨
- 코루틴 빌더 람다식에서 수신 객체로 제공되는 CoroutineScope 객체는 코루틴 빌더로 생성되는 코루틴과 람다식 내에서 CoroutineScope 객체를 사용해 실행되는 모든 코루틴을 포함함

### CoroutineScope를 새로 생성해 기존 CoroutineScope 범위에서 벗어나기

- 코루틴은 Job 객체를 사용해 구조화되는데 CoroutineScope 함수를 사용해 새로운 CoroutineScope 객체를 생성하면 기존의 계층 구조를 따르지 않는 새로운 Job 객체가 생성되어 새로운 계층 구조를 만듦
- 코루틴의 구조화를 깨는 것은 비동기 작업을 안전하지 않게 만들기 때문에 최대한 지양해야 함

### CoroutineScope 취소하기

- CoroutineScope 인터페이스의 cancel 함수는 CoroutineScope 객체의 범위에 속한 모든 코루틴을 취소하는 함수로 CoroutineScope 객체에 cancel 함수가 호출되면 범위에서 실행 중인 모든 코루틴에 취소가 요청됨
- CoroutineScope 객체에 cancel 함수가 호출되면 CoroutineScope 객체는 자신의 coroutineContext 프로퍼티를 통해 Job 객체에 접근한 후 cancel 함수를 호출함

<br>

## 구조화와 Job

> 부모 Job 객체가 없는 구조화의 시작점 역할을 하는 Job 객체를 루트 Job이라고 하고,  
> 이 Job 객체에 의해 제어되는 코루틴을 루트 코루틴이라고 함

### Job 구조화 깨기

- CoroutineScope 객체는 코루틴 실행 환경으로 CoroutineContext 객체를 갖기 때문에 코루틴과 마찬가지로 Job 객체를 가질 수 있음
- CoroutineScope 함수를 통해 CoroutineScope 객체가 생성되면 새로운 루트 Job이 생성되며, 이를 사용해 코루틴의 구조화를 깰 수 있음

### 생성된 Job의 부모를 명시적으로 설정하기

- Job()을 통해 Job 객체를 생성할 경우 parent 프로퍼티가 null이 되어 부모가 없는 루트 Job이 생성됨
- Job 생성 함수의 parent 인자로 Job 객체를 넘기면 해당 Job을 부모로 하는 새로운 Job 객체를 생성할 수 있음

### 생성된 Job은 자동으로 실행 완료되지 않는다

- Job 생성 함수를 통해 생성된 Job 객체는 자식 코루틴들이 모두 실행 완료되더라도 자동으로 실행 완료되지 않으며, 명시적으로 완료 함수인 complete을 호출해야 완료됨
