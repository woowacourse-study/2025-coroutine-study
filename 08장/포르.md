# Chapter 8. 예외 처리

## 코루틴의 예외 전파

코루틴 실행 도중 예외가 발생하면 예외가 발생한 코루틴은 취소되고 부모 코루틴으로 예외가 전파된다.  
만약 예외가 적절히 처리되지 않아 루트 코루틴까지 예외가 전파되고 루트 코루틴이 취소되면 하위의 모든 코루틴에 취소가 전파된다.

<br>

## 예외 전파 제한

### Job 객체를 사용한 예외 전파 제한

- 코루틴은 자신의 부모 코루틴으로만 예외를 전파하는 특성을 가지므로 부모 코루틴과의 구조화를 깬다면 예외가 전파되지 않음
- Job 객체를 생성해 코루틴의 구조화를 깨는 것은 예외 전파를 제한하는 것뿐만 아니라 취소 전파도 제한시킴

### SupervisorJob 객체를 사용한 예외 전파 제한

> SupervisorJob 객체는 자식 코루틴으로부터 예외를 전파받지 않는 특수한 Job 객체로  
> 하나의 자식 코루틴에서 발생한 예외가 다른 자식 코루틴에게 영향을 미치지 못하도록 만드는 데 사용된다.

- 일반적인 Job 객체는 자식 코루틴에서 예외가 발생하면 예외를 전파받아 취소되지만 SupervisorJob 객체는 예외를 전파받지 않아 취소되지 않음
- 구조화를 깨지 않고 SupervisorJob을 사용하기 위해서는 SupervisorJob의 인자로 부모 Job 객체를 넘기면 됨
- CoroutineScope의 CoroutineContext에 SupervisorJob 객체가 설정된다면 CoroutineScope의 자식 코루틴에서 발생하는 예외가 다른 자식 코루틴으로 전파되지 않음
- SupervisorJob 객체를 생성할 때 SupervisorJob 객체가 Job 계층 구조의 어떤 위치에 있어야 하는지 충분히 고민하고 사용해야 함

### supervisorScope를 사용한 예외 전파 제한

> supervisorScope 함수는 SupervisorJob 객체를 가진 CoroutineScope 객체를 생성하며,  
> 이 SupervisorJob 객체는 supervisorScope 함수를 호출한 코루틴의 Job 객체를 부모로 가진다.

- supervisorScope를 사용하면 복잡한 설정 없이도 구조화를 깨지 않고 예외 전파를 제한할 수 있음
- supervisorScope의 SupervisorJob 객체는 코드가 모두 실행되고 자식 코루틴도 모두 실행 완료되면 자동으로 완료 처리됨

<br>

## 예외 처리

### CoroutineExceptionHandler를 사용한 예외 처리

> CoroutineContext 구성 요소로 CoroutineExceptionHandler라고 하는 예외 처리기를 지원한다.

- CoroutineExceptionHandler 객체는 처리하지 않은 예외만 처리함
- 자식 코루틴이 부모 코루틴으로 예외를 전파하면 자식 코루틴에서는 예외가 처리된 것으로 봐 자식 코루틴에 설정된 CoroutineExceptionHandler 객체는 동작하지 않음
- 구조화된 코루틴상에 여러 CoroutineExceptionHandler 객체가 설정돼 있더라도 마지막으로 예외를 전파받는 위치에 설정된 CoroutineExceptionHandler 객체만 예외를 처리함
- CoroutineExceptionHandler는 예외가 마지막으로 처리되는 위치에서 예외를 처리할 뿐, 예외 전파를 제한하지 않음

### try catch문을 사용한 예외 처리

- 코루틴에서 예외가 발생했을 때 코틀린에서 일반적으로 예외를 처리하는 방식과 같이 try catch문을 통해 예외를 처리할 수 있음
- 코루틴 빌더 함수에 try catch문을 사용하면 코루틴에서 발생한 예외가 잡히지 않음
- 코루틴에 대한 예외 처리를 위해서는 코루틴 빌더 함수의 람다식 내부에서 try catch문을 사용해야 함

### async의 예외 처리

- 코루틴 실행 도중 예외가 발생해 결괏값이 없다면 Deferred에 대한 await 호출 시 예외가 노출됨
- async 코루틴 빌더를 호출해 만들어진 코루틴에서 예외가 발생한 경우에는 await 호출부에서 예외 처리를 해야 함
- async 코루틴 빌더 함수도 예외가 발생하면 부모 코루틴으로 예외를 전파함

<br>

## 전파되지 않는 예외

### CancellationException

- 코루틴은 CancellationException 예외가 발생해도 부모 코루틴으로 전파되지 않음

### JobCancellationException

- Job 객체에 대해 cancel 함수를 호출하면 CancellationException의 서브 클래스인 JobCancellationException을 발생시켜 코루틴을 취소시킴

### TimeoutCancellationException

- withTimeOut 함수는 작업이 주어진 시간 내에 완료되지 않으면 CancellationException의 서브 클래스인 TimeoutCancellationException을 발생시킴
- withTimeOut 함수는 실행 시간이 제한되어야 할 필요가 있는 다양한 작업에 사용되며, 대표적으로 네트워크 호출의 실행 시간을 제한하는 데 사용할 수 있음
